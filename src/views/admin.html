<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - SimpleMovieSync</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">SimpleMovieSync</div>
      <nav class="nav-links">
        <a href="/">Home</a>
        <a href="/admin">Admin Panel</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 style="margin-bottom: 30px;">Admin Panel</h1>

    <div class="grid-2">
      <!-- Upload Section -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Upload Movie</h2>
        </div>
        <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">Click or drag a video file here</p>
          <p class="text-muted">Supports MP4, MKV, AVI, WebM (up to 10GB)</p>
          <input type="file" id="file-input" accept="video/*" hidden onchange="handleFileSelect(event)">
        </div>
        <div id="upload-progress" class="hidden mt-20">
          <p id="upload-status">Uploading...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="upload-progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Rooms Section -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Active Rooms</h2>
          <button class="btn btn-secondary" onclick="loadRooms()">Refresh</button>
        </div>
        <div class="room-list" id="room-list">
          <p class="text-muted text-center">Loading rooms...</p>
        </div>
      </div>
    </div>

    <!-- Movies Section -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Movies Library</h2>
        <button class="btn btn-secondary" onclick="loadMovies()">Refresh</button>
      </div>
      <div class="movie-list" id="movie-list">
        <p class="text-muted text-center">Loading movies...</p>
      </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal-overlay" id="create-room-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Create Room</h3>
          <button class="modal-close" onclick="closeCreateRoomModal()">&times;</button>
        </div>
        <form id="create-room-form" onsubmit="submitCreateRoom(event)">
          <input type="hidden" id="room-movie-id">
          <div class="form-group">
            <label class="form-label">Room Name</label>
            <input type="text" class="form-input" id="room-name" placeholder="Enter room name" maxlength="50">
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Create Room</button>
        </form>
      </div>
    </div>

    <!-- Transcode Modal -->
    <div class="modal-overlay" id="transcode-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Transcode Movie</h3>
          <button class="modal-close" onclick="closeTranscodeModal()">&times;</button>
        </div>
        <form id="transcode-form" onsubmit="submitTranscode(event)">
          <input type="hidden" id="transcode-movie-id">
          <div class="form-group">
            <label class="form-label">Select Qualities</label>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" name="quality" value="360p" checked> 360p (640x360)
              </label>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" name="quality" value="480p" checked> 480p (854x480)
              </label>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" name="quality" value="720p" checked> 720p (1280x720)
              </label>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" name="quality" value="1080p" checked> 1080p (1920x1080)
              </label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Start Transcoding</button>
        </form>
      </div>
    </div>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let movies = [];
    let rooms = [];

    // Join admin room for updates
    socket.emit('joinAdmin');

    // Socket event listeners
    socket.on('transcodeProgress', ({ movieId, progress }) => {
      updateMovieProgress(movieId, progress);
    });

    socket.on('transcodeComplete', ({ movieId, qualities }) => {
      loadMovies();
      alert('Transcoding complete! You can now create a room with this movie.');
    });

    socket.on('transcodeError', ({ movieId, error }) => {
      loadMovies();
      alert('Transcoding failed: ' + error);
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMovies();
      loadRooms();
    });

    // File upload handling
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        uploadFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadFile(file);
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('movie', file);

      const progressDiv = document.getElementById('upload-progress');
      const progressFill = document.getElementById('upload-progress-fill');
      const statusText = document.getElementById('upload-status');

      progressDiv.classList.remove('hidden');
      statusText.textContent = `Uploading: ${file.name}`;

      try {
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percent + '%';
            statusText.textContent = `Uploading: ${file.name} (${percent}%)`;
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const result = JSON.parse(xhr.responseText);
            statusText.textContent = 'Upload complete!';
            progressFill.style.width = '100%';
            loadMovies();
            setTimeout(() => {
              progressDiv.classList.add('hidden');
              progressFill.style.width = '0%';
            }, 2000);
          } else {
            throw new Error('Upload failed');
          }
        });

        xhr.addEventListener('error', () => {
          throw new Error('Upload failed');
        });

        xhr.open('POST', '/api/upload');
        xhr.send(formData);
      } catch (error) {
        statusText.textContent = 'Upload failed: ' + error.message;
        progressFill.style.backgroundColor = 'var(--error-color)';
      }
    }

    // Load movies
    async function loadMovies() {
      try {
        const response = await fetch('/api/movies');
        movies = await response.json();
        renderMovies();
      } catch (error) {
        console.error('Failed to load movies:', error);
        document.getElementById('movie-list').innerHTML = '<p class="text-muted text-center">Failed to load movies</p>';
      }
    }

    function renderMovies() {
      const container = document.getElementById('movie-list');

      if (movies.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No movies uploaded yet. Upload a movie to get started!</p>';
        return;
      }

      container.innerHTML = movies.map(movie => `
        <div class="movie-item">
          <div class="movie-info">
            <h4>${escapeHtml(movie.originalName)}</h4>
            <p>
              ${formatFileSize(movie.size)} -
              <span class="badge badge-${movie.transcodeStatus}">${movie.transcodeStatus}</span>
              ${movie.transcodeProgress ? `(${movie.transcodeProgress.overallProgress}%)` : ''}
            </p>
            ${movie.qualities.length > 0 ? `<p>Qualities: ${movie.qualities.map(q => q.quality).join(', ')}</p>` : ''}
          </div>
          <div class="movie-actions">
            ${movie.transcodeStatus === 'pending' ? `
              <button class="btn btn-primary" onclick="openTranscodeModal('${movie.id}')">Transcode</button>
            ` : ''}
            ${movie.transcodeStatus === 'completed' ? `
              <button class="btn btn-success" onclick="openCreateRoomModal('${movie.id}')">Create Room</button>
            ` : ''}
            ${movie.transcodeStatus === 'processing' ? `
              <span class="badge badge-processing">Processing...</span>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function updateMovieProgress(movieId, progress) {
      const movie = movies.find(m => m.id === movieId);
      if (movie) {
        movie.transcodeProgress = progress;
        renderMovies();
      }
    }

    // Load rooms
    async function loadRooms() {
      try {
        const response = await fetch('/api/rooms');
        rooms = await response.json();
        renderRooms();
      } catch (error) {
        console.error('Failed to load rooms:', error);
        document.getElementById('room-list').innerHTML = '<p class="text-muted text-center">Failed to load rooms</p>';
      }
    }

    function renderRooms() {
      const container = document.getElementById('room-list');

      if (rooms.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No active rooms. Create a room from a transcoded movie!</p>';
        return;
      }

      container.innerHTML = rooms.map(room => `
        <div class="room-item">
          <div class="room-info">
            <h4>${escapeHtml(room.name)}</h4>
            <p>
              Movie: ${escapeHtml(room.movie.originalName)} |
              <span class="viewer-count"><span class="viewer-dot"></span> ${room.viewerCount || 0} watching</span>
            </p>
          </div>
          <div class="movie-actions">
            <a href="/watch/${room.id}" class="btn btn-secondary" target="_blank">View</a>
            <button class="btn btn-secondary" onclick="copyRoomLink('${room.id}')">Copy Link</button>
            <button class="btn btn-danger" onclick="deleteRoom('${room.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Modal functions
    function openTranscodeModal(movieId) {
      document.getElementById('transcode-movie-id').value = movieId;
      document.getElementById('transcode-modal').classList.add('active');
    }

    function closeTranscodeModal() {
      document.getElementById('transcode-modal').classList.remove('active');
    }

    async function submitTranscode(event) {
      event.preventDefault();
      const movieId = document.getElementById('transcode-movie-id').value;
      const checkboxes = document.querySelectorAll('#transcode-form input[name="quality"]:checked');
      const qualities = Array.from(checkboxes).map(cb => cb.value);

      if (qualities.length === 0) {
        alert('Please select at least one quality');
        return;
      }

      try {
        const response = await fetch(`/api/movies/${movieId}/transcode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qualities })
        });

        if (response.ok) {
          closeTranscodeModal();
          loadMovies();
        } else {
          const error = await response.json();
          alert('Failed to start transcoding: ' + error.error);
        }
      } catch (error) {
        alert('Failed to start transcoding: ' + error.message);
      }
    }

    function openCreateRoomModal(movieId) {
      document.getElementById('room-movie-id').value = movieId;
      document.getElementById('room-name').value = '';
      document.getElementById('create-room-modal').classList.add('active');
    }

    function closeCreateRoomModal() {
      document.getElementById('create-room-modal').classList.remove('active');
    }

    async function submitCreateRoom(event) {
      event.preventDefault();
      const movieId = document.getElementById('room-movie-id').value;
      const name = document.getElementById('room-name').value.trim();

      try {
        const response = await fetch('/api/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ movieId, name })
        });

        if (response.ok) {
          const result = await response.json();
          closeCreateRoomModal();
          loadRooms();

          // Show success with room link
          const link = `${window.location.origin}/watch/${result.room.id}`;
          if (confirm(`Room created! Link: ${link}\n\nCopy link to clipboard?`)) {
            navigator.clipboard.writeText(link);
          }
        } else {
          const error = await response.json();
          alert('Failed to create room: ' + error.error);
        }
      } catch (error) {
        alert('Failed to create room: ' + error.message);
      }
    }

    async function deleteRoom(roomId) {
      if (!confirm('Are you sure you want to delete this room? All viewers will be disconnected.')) {
        return;
      }

      try {
        const response = await fetch(`/api/rooms/${roomId}`, { method: 'DELETE' });
        if (response.ok) {
          loadRooms();
        } else {
          alert('Failed to delete room');
        }
      } catch (error) {
        alert('Failed to delete room: ' + error.message);
      }
    }

    function copyRoomLink(roomId) {
      const link = `${window.location.origin}/watch/${roomId}`;
      navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
      });
    }

    // Utility functions
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          e.target.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
